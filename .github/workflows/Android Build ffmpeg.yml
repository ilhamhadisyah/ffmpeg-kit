name: Build ffmpeg-kit full LTS (Android)

on:
  workflow_dispatch:
    inputs:
      enable_gpl:
        description: 'Enable GPL codecs (x264/x265, etc.)'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout ffmpeg-kit
        uses: actions/checkout@v4
        with:
          repository: arthenica/ffmpeg-kit
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool pkg-config curl git nasm doxygen \
            make cmake unzip zip build-essential

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r23c and platforms
        run: |
          sdkmanager --install "platform-tools" "platforms;android-29" "ndk;23.2.8568313"

      - name: Export env vars
        run: |
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${ANDROID_SDK_ROOT}/ndk/23.2.8568313" >> $GITHUB_ENV

      - name: Build (Full + LTS)
        run: |
          set -e
          chmod +x android.sh
          if [ "${{ github.event.inputs.enable_gpl }}" = "true" ]; then
            ./android.sh --full --enable-gpl --lts
          else
            ./android.sh --full --lts
          fi

      - name: Upload AARs
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-android-full-LTS
          path: prebuilt/bundle-android-aar-lts/*.aar

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
